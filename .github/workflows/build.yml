name: Build FFmpeg

on: 
  push:
  workflow_dispatch:
  schedule:
    - cron: 0 0 * * *

jobs:
  build:
    runs-on: ubuntu-latest
    steps: 
    - name: Checkout FFmpeg code
      uses: actions/checkout@v2
      with:
        repository: hexahigh/FFmpeg

    - name: Add apt repo
      run: echo "deb [signed-by=/usr/share/keyrings/boofdev.apt.pub] https://apt.080609.xyz stable main" | sudo tee -a /etc/apt/sources.list.d/boofdev.list && sudo wget -q -O /usr/share/keyrings/boofdev.apt.pub https://apt.080609.xyz/pgp-key.public

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y autoconf automake build-essential libtool pkg-config libogg-dev libass-dev nasm yasm libx264-dev libx265-dev libvpx-dev libfdk-aac-dev libopus-dev libmp3lame-dev libsvtav1-dev libvorbis-dev

    - name: Build FFmpeg
      run: |
        ./configure \
          --prefix=/tmp/f_build \
          --ld="g++" \
          --enable-libvmaf \
          --enable-gpl \
          --enable-libass \
          --enable-nonfree \
          --enable-libx264 \
          --enable-libx265 \
          --enable-libvpx \
          --enable-libfdk-aac \
          --enable-libmp3lame \
          --enable-libopus \
          --enable-libvorbis \
          --enable-libsvtav1 
        make
        sudo make install

    - name: Release to GitHub
      uses: ncipollo/release-action@v1
      with:
        name: Latest Autobuild
        tag: latest_auto
        commit: main
        body: ${{ github.event.head_commit.message }}
        artifacts: "/tmp/f_build/ffplay, /tmp/f_build/ffprove, /tmp/f_build/ffmpeg,"
        prerelease: false
